{% extends "base_dashboard.html" %}
{% block title %}Edit Profile{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body p-5">
          <h2 class="mb-4 text-center fw-bold primary_color">Edit Profile</h2>

          <div id="alert-container"></div>

          <form id="profileForm" method="post">
            {% csrf_token %}
            {% for field in form %}
              <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
                <div class="text-danger small" id="error_{{ field.name }}"></div>
              </div>
            {% endfor %}
            <button type="submit" class="btn btn-logout m-1 w-100">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).on("submit", "#profileForm", function(e) {
    e.preventDefault();
    let form = $(this);

    $.ajax({
        url: "{% url 'login_registration_app:profile_edit' %}",
        method: "POST",
        data: form.serialize(),
        success: function(response) {
            if (response.success) {
                $("#alert-container").html(
                    `<div class="alert alert-success alert-dismissible fade show" role="alert">
                        ${response.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`
                );

                if (response.updated_name) {
                    $(".navbar-brand .primary_color").text("Welcome " + response.updated_name);
                }

                setTimeout(() => {
                    window.location.href = response.redirect_url;
                }, 1500);

            } else if (response.redirect_url) {
                $("#alert-container").html(
                    `<div class="alert alert-warning alert-dismissible fade show" role="alert">
                        ${response.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`
                );
                setTimeout(() => {
                    window.location.href = response.redirect_url;
                }, 1500);

            } else {
                $("#alert-container").html(
                    `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                        Please fix the errors below.
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`
                );
                $(".text-danger.small").empty();
                for (const [field, error] of Object.entries(response.errors)) {
                    $(`#error_${field}`).text(error[0]);
                }
            }
        },
        error: function() {
            $("#alert-container").html(
                `<div class="alert alert-danger alert-dismissible fade show" role="alert">
                    Something went wrong. Try again.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`
            );
        }
    });
});
</script>
{% endblock %}