{% extends "base_dashboard.html" %}
{% load static %}
{% block title %}Case Detail{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="card shadow-sm border-0 rounded-4 p-4">
    <h3>{{ case.category.name }}</h3>
    <p>{{ case.description }}</p>
    <p><strong>Needed:</strong> ${{ case.price }}</p>
    <p>
      <strong>Status:</strong> 
      <span id="caseStatusBadge" class="badge 
        {% if case.status == 'approved' %}bg-info
        {% elif case.status == 'delivered' %}bg-success
        {% elif case.status == 'rejected' %}bg-danger
        {% else %}bg-warning text-dark{% endif %}">
        {{ case.status|title }}
      </span>
    </p>
<p>
  <strong>Contact:</strong> 
  <a href="{{ case.user.link_watsapp }}" target="_blank">
    <img src="{% static 'img/watsapp-icon.png' %}" 
         alt="WhatsApp" 
        >
  </a>
</p>
    <h5>Attachments:</h5>
    <ul>
      {% for file in attachments %}
        <li>
          <a href="{{ file.file.url }}" target="_blank">View Proof</a> ({{ file.status }})
        </li>
      {% empty %}
        <p>No attachments.</p>
      {% endfor %}
    </ul>

    <form id="donateForm">
      {% csrf_token %}
      <div class="mb-3">
        <label for="amount" class="mb-1">Donation Amount (USD)</label>
        <input type="number" id="amount" name="amount" class="form-control " required min="1">
      </div>
      <button type="submit" class="btn btn-logout m-1">Adopt Case</button>
    </form>

    <div id="donateMessage" class="mt-3"></div>
  </div>
</div>

<script>
document.getElementById("donateForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const amount = document.getElementById("amount").value;

  fetch("{% url 'donor_app:adopt_case' case.id %}", {
    method: "POST",
    headers: {
      "X-CSRFToken": "{{ csrf_token }}",
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: new URLSearchParams({ amount: amount })
  })
  .then(res => res.json())
  .then(data => {
    const msgDiv = document.getElementById("donateMessage");
    if (data.success) {
      msgDiv.innerHTML = `<div class="alert alert-success">${data.message}</div>`;

      const badge = document.getElementById("caseStatusBadge");
      badge.textContent = "Delivered";
      badge.className = "badge bg-success";
    } else {
      msgDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
    }
  })
  .catch(err => console.error(err));
});
</script>
{% endblock %}