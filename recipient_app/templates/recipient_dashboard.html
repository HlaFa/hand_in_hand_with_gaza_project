{% extends "base_dashboard.html" %}
{% load static %}
{% block title %}Recipient Dashboard{% endblock %}

{% block content %}
<div class="container py-5">

  <div class="text-center mb-5">
    <h2 class="fw-bold primary_color">Recipient Dashboard</h2>
    <p class="text-muted">Submit new cases and track their progress in real time</p>
  </div>

  <!-- Case submission form -->
  <div class="card shadow-sm border-0 rounded-4 mb-5">
    <div class="card-body p-4">
      <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        <div class="mb-3">
          <label for="id_description" class="form-label fw-semibold">Case Description</label>
          {{ form.description }}
          <div class="form-text text-muted">Describe the case clearly (e.g., medical, food, shelter).</div>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="id_price" class="form-label fw-semibold">Amount Needed (USD)</label>
            {{ form.price }}
          </div>
          <div class="col-md-6 mb-3">
            <label for="id_category" class="form-label fw-semibold">Category</label>
            {{ form.category }}
          </div>
        </div>

        <div class="mb-4">
          <label for="id_attachment" class="form-label fw-semibold">Upload Proof</label>
          {{ form.attachment }}
          <div class="form-text text-muted">Upload supporting document (e.g., medical report, payment receipt, financial proof).</div>
        </div>

        <button type="submit" class="btn btn-logout w-100">
          <i class="bi bi-upload me-1"></i> Submit Case
        </button>
      </form>
    </div>
  </div>

  <!-- My cases -->
  <h4 class="fw-bold primary_color mb-4">
    <i class="bi bi-folder-check me-2"></i> My Submitted Cases
  </h4>

  {% for case in my_cases %}
  <div class="card shadow-sm border-0 rounded-4 mb-4 hover-shadow" data-case-id="{{ case.id }}">
    <div class="card-body p-4">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h5 class="fw-bold">{{ case.category.name }}</h5>
          <p class="text-muted mb-2">{{ case.description }}</p>
          <p class="mb-1"><strong>Amount Needed:</strong> ${{ case.price }}</p>
          <p class="mb-1">
            <strong>Status:</strong>
            <!-- üëá ADD UNIQUE ID FOR BADGE -->
            <span id="status-badge-{{ case.id }}" class="badge px-3 py-2 rounded-pill
                {% if case.status|lower == 'pending' %} bg-warning text-dark
                {% elif case.status|lower == 'approved' %} bg-info
                {% elif case.status|lower == 'rejected' %} bg-danger
                {% elif case.status|lower == 'delivered' %} bg-success
                {% endif %}">
              {{ case.status|title }}
            </span>
          </p>
        </div>

        <div class="text-end">
          <i class="bi bi-file-earmark-text fs-1 text-secondary"></i>

          {% if case.status|lower == "rejected" %}
          <form method="post" action="{% url 'recipient_app:delete_case' case.id %}" style="display:inline;">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-outline-danger mt-2">
              <i class="bi bi-x-circle"></i> X
            </button>
          </form>
          {% endif %}
        </div>
      </div>

      <!-- üëá ADD UNIQUE ID FOR MESSAGE -->
      <p id="status-msg-{{ case.id }}" class="small mt-3">
        {% if case.status|lower == 'pending' %}
        ‚è≥ Waiting for admin approval of your proof.
        {% elif case.status|lower == 'approved' %}
        ‚úî Your case is approved and visible to donors.
        {% elif case.status|lower == 'rejected' %}
        ‚ùå Your proof was rejected. Please upload a valid document and resubmit.
        {% elif case.status|lower == 'delivered' %}
        üéâ Your case has been fully funded!
        {% endif %}
      </p>
    </div>
  </div>
  {% empty %}
  <div class="alert alert-info text-center rounded-3">
    <i class="bi bi-info-circle me-2"></i> You haven‚Äôt submitted any cases yet.
  </div>
  {% endfor %}

</div>
{% endblock %}

{% block scripts %}
<script src="{% static 'js/script.js' %}"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    setTimeout(() => {
      document.querySelectorAll('.alert').forEach(el => el.style.display = 'none');
    }, 4000);

    document.querySelectorAll("[data-case-id]").forEach(el => {
      const caseId = el.dataset.caseId;
      setInterval(() => updateCaseStatus(caseId), 3000);
    });
  });
function updateCaseStatus(caseId) {
  fetch(`/case-status/${caseId}/`, { cache: "no-store" })
    .then(response => response.json())
    .then(data => {


      if (data.status) {
        const badge = document.getElementById(`status-badge-${caseId}`);
        const msg = document.getElementById(`status-msg-${caseId}`);
        const status = data.status.toLowerCase();

        if (badge) {
          badge.className = "badge px-3 py-2 rounded-pill " + {
            "pending": "bg-warning text-dark",
            "approved": "bg-info",
            "rejected": "bg-danger",
            "delivered": "bg-success"
          }[status];
          badge.textContent = data.status;
        }

        if (msg) {
          msg.textContent = {
            "pending": "‚è≥ Waiting for admin approval of your proof.",
            "approved": "‚úî Your case is approved and visible to donors.",
            "rejected": "‚ùå Your proof was rejected. Please upload a valid document and resubmit.",
            "delivered": "üéâ Your case has been fully funded!"
          }[status];
        }
      }
    })
    .catch(err => console.error("Error fetching case status:", err));
}

</script>
{% endblock %}
